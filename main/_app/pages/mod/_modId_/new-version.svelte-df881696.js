import{S as x,i as ee,s as te,G as T,H as M,I as q,m as E,t as U,L as A,aD as re,u as oe,W as ne,b as N,a as D,e as y,B as I,ai as se,f as _,g as F,c as j,d as S,C as P,A as C,a3 as v,j as w,l as B,X as ae,Y as R,_ as W,$ as X,Z as G,aE as ie,k as Y,w as H,U as le,D as L,r as z,h as Z}from"../../../chunks/vendor-556bddb0.js";import{p as ce}from"../../../chunks/routing-689f9c1f.js";import{T as fe}from"../../../chunks/Toast-9a5a4434.js";import{g as ue}from"../../../chunks/navigation-d7362a67.js";import{V as de}from"../../../chunks/VersionForm-10a362c9.js";import{x as me,C as pe,y as _e,z as he,F as ke}from"../../../chunks/graphql-b763070c.js";import{b as be}from"../../../chunks/paths-396f020f.js";import{M as ge}from"../../../chunks/MetaDescriptors-27aa6f3e.js";import"../../../chunks/singletons-d19c42e4.js";import"../../../chunks/forms-3cca3ec1.js";import"../../../chunks/jszip-b1f4f406.js";import"../../../chunks/extras-2ac9de80.js";import"../../../chunks/uplugin-4824e5c7.js";import"../../../chunks/api-82c76902.js";import"../../../chunks/user-d1f56c1d.js";import"../../../chunks/forms-98611724.js";import"../../../chunks/markdown-17d20b45.js";import"../../../chunks/formatting-24701f16.js";import"../../../chunks/stores-e6767543.js";const ve=async(i,e,r,t,n)=>{const a=1e7,o=Math.ceil(i.size/a),u=new Array(o).fill(0).map((m,f)=>f).reverse(),l=(m,f,g)=>n.uploadVersionPart({modId:e,versionId:g,part:f,file:m}),b=10;let h=0,d=0;const $=m=>{if(h>=b||!u.length)return;const f=u.pop(),g=f*a,k=i.slice(g,g+a);return h+=1,Promise.all([l(k,f+1,m).then(()=>(h-=1,t.set({total:o,uploaded:o-u.length-h}),$(m))).catch(s=>{if(console.error("Upload failed:",s),h-=1,u.push(f),d+=1,d<5)return $(m);throw new Error("Failed uploading after 5 attempts")}),$(m)])};return n.createVersion({modId:e}).then(async m=>(t.set({total:o,uploaded:0}),await $(m.data.createVersion),m.data.createVersion)).then(m=>(console.log("Finalizing",{versionID:m}),n.finalizeCreateVersion({modId:e,versionId:m,version:r}).then(()=>new Promise((f,g)=>{let k=0;const s=setInterval(()=>{if(k==60)return clearInterval(s),g(new Error("Timed out waiting for mod processing"));n.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),k++},1e4);n.checkVersionUploadState.variables.versionId=m;const p=n.checkVersionUploadState.subscribe(c=>{if(!c.fetching){if(c.error){clearInterval(s),g(new Error(c.error.message)),setTimeout(p);return}!c.data||!c.data.checkVersionUploadState||!c.data.checkVersionUploadState.version||!c.data.checkVersionUploadState.version.id||(p(),clearInterval(s),f(c.data.checkVersionUploadState))}})})))).catch(m=>{throw console.error(m),m})};function J(i){let e,r;return e=new ge({props:{description:"Creating a new version of mod "+i[1].data.mod.name,title:"New version of mod "+i[1].data.mod.name}}),{c(){T(e.$$.fragment)},l(t){M(e.$$.fragment,t)},m(t,n){q(e,t,n),r=!0},p(t,n){const a={};n&2&&(a.description="Creating a new version of mod "+t[1].data.mod.name),n&2&&(a.title="New version of mod "+t[1].data.mod.name),e.$set(a)},i(t){r||(E(e.$$.fragment,t),r=!0)},o(t){U(e.$$.fragment,t),r=!1},d(t){A(e,t)}}}function $e(i){let e=i[1].data.mod.name+"",r;return{c(){r=I(e)},l(t){r=P(t,e)},m(t,n){w(t,r,n)},p(t,n){n&2&&e!==(e=t[1].data.mod.name+"")&&L(r,e)},d(t){t&&_(r)}}}function we(i){let e;return{c(){e=I("...")},l(r){e=P(r,"...")},m(r,t){w(r,e,t)},p:z,d(r){r&&_(e)}}}function Ve(i){let e,r,t,n;e=new de({props:{onSubmit:i[8],modReference:i[1].data.mod.mod_reference}});let a=i[3]&&K(i);return{c(){T(e.$$.fragment),r=D(),a&&a.c(),t=N()},l(o){M(e.$$.fragment,o),r=F(o),a&&a.l(o),t=N()},m(o,u){q(e,o,u),w(o,r,u),a&&a.m(o,u),w(o,t,u),n=!0},p(o,u){const l={};u&2&&(l.modReference=o[1].data.mod.mod_reference),e.$set(l),o[3]?a?a.p(o,u):(a=K(o),a.c(),a.m(t.parentNode,t)):a&&(a.d(1),a=null)},i(o){n||(E(e.$$.fragment,o),n=!0)},o(o){U(e.$$.fragment,o),n=!1},d(o){A(e,o),o&&_(r),a&&a.d(o),o&&_(t)}}}function ye(i){let e,r,t=i[1].error.message+"",n;return{c(){e=y("p"),r=I("Oh no... "),n=I(t)},l(a){e=j(a,"P",{});var o=S(e);r=P(o,"Oh no... "),n=P(o,t),o.forEach(_)},m(a,o){w(a,e,o),v(e,r),v(e,n)},p(a,o){o&2&&t!==(t=a[1].error.message+"")&&L(n,t)},i:z,o:z,d(a){a&&_(e)}}}function je(i){let e,r;return{c(){e=y("p"),r=I("Loading...")},l(t){e=j(t,"P",{});var n=S(e);r=P(n,"Loading..."),n.forEach(_)},m(t,n){w(t,e,n),v(e,r)},p:z,i:z,o:z,d(t){t&&_(e)}}}function K(i){let e,r,t,n,a,o,u,l,b=i[4].toFixed(0)+"",h,d,$,m,f;return{c(){e=y("div"),r=y("div"),t=y("div"),n=y("span"),a=I(i[3]),o=D(),u=y("div"),l=y("span"),h=I(b),d=I("%"),$=D(),m=y("div"),f=y("div"),this.h()},l(g){e=j(g,"DIV",{class:!0});var k=S(e);r=j(k,"DIV",{class:!0});var s=S(r);t=j(s,"DIV",{});var p=S(t);n=j(p,"SPAN",{class:!0});var c=S(n);a=P(c,i[3]),c.forEach(_),p.forEach(_),o=F(s),u=j(s,"DIV",{class:!0});var V=S(u);l=j(V,"SPAN",{class:!0});var Q=S(l);h=P(Q,b),d=P(Q,"%"),Q.forEach(_),V.forEach(_),s.forEach(_),$=F(k),m=j(k,"DIV",{class:!0});var O=S(m);f=j(O,"DIV",{style:!0,class:!0}),S(f).forEach(_),O.forEach(_),k.forEach(_),this.h()},h(){C(n,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),C(l,"class","text-xs font-semibold inline-block text-white"),C(u,"class","text-right"),C(r,"class","flex mb-2 items-center justify-between"),Z(f,"width",i[4].toFixed(0)+"%"),C(f,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),C(m,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),C(e,"class","relative pt-4")},m(g,k){w(g,e,k),v(e,r),v(r,t),v(t,n),v(n,a),v(r,o),v(r,u),v(u,l),v(l,h),v(l,d),v(e,$),v(e,m),v(m,f)},p(g,k){k&8&&L(a,g[3]),k&16&&b!==(b=g[4].toFixed(0)+"")&&L(h,b),k&16&&Z(f,"width",g[4].toFixed(0)+"%")},d(g){g&&_(e)}}}function Se(i){let e,r,t,n;const a=[je,ye,Ve],o=[];function u(l,b){return l[1].fetching?0:l[1].error?1:2}return e=u(i),r=o[e]=a[e](i),{c(){r.c(),t=N()},l(l){r.l(l),t=N()},m(l,b){o[e].m(l,b),w(l,t,b),n=!0},p(l,b){let h=e;e=u(l),e===h?o[e].p(l,b):(Y(),U(o[h],1,1,()=>{o[h]=null}),B(),r=o[e],r?r.p(l,b):(r=o[e]=a[e](l),r.c()),E(r,1),r.m(t.parentNode,t))},i(l){n||(E(r),n=!0)},o(l){U(r),n=!1},d(l){o[e].d(l),l&&_(t)}}}function Ee(i){let e,r;return e=new ie({props:{$$slots:{default:[Se]},$$scope:{ctx:i}}}),{c(){T(e.$$.fragment)},l(t){M(e.$$.fragment,t)},m(t,n){q(e,t,n),r=!0},p(t,n){const a={};n&65562&&(a.$$scope={dirty:n,ctx:t}),e.$set(a)},i(t){r||(E(e.$$.fragment,t),r=!0)},o(t){U(e.$$.fragment,t),r=!1},d(t){A(e,t)}}}function Ie(i){let e,r;return{c(){e=y("span"),r=I(i[2])},l(t){e=j(t,"SPAN",{});var n=S(e);r=P(n,i[2]),n.forEach(_)},m(t,n){w(t,e,n),v(e,r)},p(t,n){n&4&&L(r,t[2])},d(t){t&&_(e)}}}function Pe(i){let e,r,t,n,a,o,u,l,b,h,d=!i[1].fetching&&!i[1].error&&i[1].data.mod&&J(i);function $(s,p){if(s[1].fetching)return we;if(!s[1].error)return $e}let m=$(i),f=m&&m(i);o=new re({props:{$$slots:{default:[Ee]},$$scope:{ctx:i}}});function g(s){i[10](s)}let k={$$slots:{default:[Ie]},$$scope:{ctx:i}};return i[0]!==void 0&&(k.running=i[0]),l=new fe({props:k}),oe.push(()=>ne(l,"running",g)),{c(){d&&d.c(),e=N(),r=D(),t=y("h1"),n=I(`New Version for
  `),f&&f.c(),a=D(),T(o.$$.fragment),u=D(),T(l.$$.fragment),this.h()},l(s){const p=se('[data-svelte="svelte-qrqlce"]',document.head);d&&d.l(p),e=N(),p.forEach(_),r=F(s),t=j(s,"H1",{class:!0});var c=S(t);n=P(c,`New Version for
  `),f&&f.l(c),c.forEach(_),a=F(s),M(o.$$.fragment,s),u=F(s),M(l.$$.fragment,s),this.h()},h(){C(t,"class","text-4xl my-4 font-bold")},m(s,p){d&&d.m(document.head,null),v(document.head,e),w(s,r,p),w(s,t,p),v(t,n),f&&f.m(t,null),w(s,a,p),q(o,s,p),w(s,u,p),q(l,s,p),h=!0},p(s,[p]){!s[1].fetching&&!s[1].error&&s[1].data.mod?d?(d.p(s,p),p&2&&E(d,1)):(d=J(s),d.c(),E(d,1),d.m(e.parentNode,e)):d&&(Y(),U(d,1,1,()=>{d=null}),B()),m===(m=$(s))&&f?f.p(s,p):(f&&f.d(1),f=m&&m(s),f&&(f.c(),f.m(t,null)));const c={};p&65562&&(c.$$scope={dirty:p,ctx:s}),o.$set(c);const V={};p&65540&&(V.$$scope={dirty:p,ctx:s}),!b&&p&1&&(b=!0,V.running=s[0],ae(()=>b=!1)),l.$set(V)},i(s){h||(E(d),E(o.$$.fragment,s),E(l.$$.fragment,s),h=!0)},o(s){U(d),U(o.$$.fragment,s),U(l.$$.fragment,s),h=!1},d(s){d&&d.d(s),_(e),s&&_(r),s&&_(t),f&&f.d(),s&&_(a),A(o,s),s&&_(u),A(l,s)}}}const Ze=ce();function Ue(i,e,r){let t,n,a,{modId:o}=e;const u=H("");R(i,u,c=>r(3,n=c));const l=H(0);R(i,l,c=>r(4,a=c));const b=H();b.subscribe(c=>{c&&(c.uploaded===c.total?(u.set("Processing..."),l.set(100)):(u.set(`Uploading: ${c.uploaded}/${c.total}`),l.set(c.uploaded/c.total*100)))});let h="",d=!1;const $=W(me,{mod:o});R(i,$,c=>r(1,t=c)),X($);const m=G({query:_e}),f=G({query:he}),g=G({query:ke}),k=W(pe,{versionId:void 0,modId:void 0},{pause:!0});X(k);const s=async c=>ve(c.file,le($).data.mod.id,{changelog:c.changelog,stability:c.stability},b,{createVersion:m,uploadVersionPart:f,finalizeCreateVersion:g,checkVersionUploadState:k}).then(V=>{console.log({success:V}),ue(be+"/mod/"+o+"/version/"+V.version.id)}).catch(V=>{console.error(V),r(2,h="Error creating version: "+V.message),r(0,d=!0),u.set("")});function p(c){d=c,r(0,d)}return i.$$set=c=>{"modId"in c&&r(9,o=c.modId)},i.$$.update=()=>{i.$$.dirty&2&&t.data&&(k.variables.modId=t.data.mod.id),i.$$.dirty&1&&(d||r(2,h=""))},[d,t,h,n,a,u,l,$,s,o,p]}class Je extends x{constructor(e){super();ee(this,e,Ue,Pe,te,{modId:9})}}export{Je as default,Ze as load};
//# sourceMappingURL=new-version.svelte-df881696.js.map
