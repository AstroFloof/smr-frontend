import{S as x,i as ee,s as te,w as z,x as M,y as q,q as E,o as C,B as A,aA as re,M as oe,N as ne,l as U,k as F,e as y,t as P,ab as se,d as _,m as D,c as S,a as j,h as I,b as N,X as v,g as w,p as H,O as ae,P as O,R as K,T as X,Q as L,aC as ie,n as Z,D as B,K as le,j as Q,Z as T,f as J}from"../../../chunks/vendor-eae803c8.js";import{p as ce}from"../../../chunks/routing-689f9c1f.js";import{T as fe}from"../../../chunks/Toast-66ef6034.js";import{g as ue}from"../../../chunks/navigation-ca50617e.js";import{V as de}from"../../../chunks/VersionForm-2db66cf7.js";import{x as me,C as pe,y as _e,z as he,F as be}from"../../../chunks/graphql-4793b2e5.js";import{b as ke}from"../../../chunks/paths-396f020f.js";import{M as ge}from"../../../chunks/MetaDescriptors-d3a064af.js";import"../../../chunks/singletons-4fc5a6de.js";import"../../../chunks/uplugin-65c64637.js";import"../../../chunks/api-82c76902.js";import"../../../chunks/user-5d1f456f.js";import"../../../chunks/forms-7d0fc3bf.js";import"../../../chunks/markdown-73d64a89.js";import"../../../chunks/formatting-24701f16.js";import"../../../chunks/stores-b4bb6f59.js";const ve=async(i,e,r,t,n)=>{const a=1e7,o=Math.ceil(i.size/a),u=new Array(o).fill(0).map((m,f)=>f).reverse(),l=(m,f,g)=>n.uploadVersionPart({modId:e,versionId:g,part:f,file:m}),k=10;let h=0,d=0;const $=m=>{if(h>=k||!u.length)return;const f=u.pop(),g=f*a,b=i.slice(g,g+a);return h+=1,Promise.all([l(b,f+1,m).then(()=>(h-=1,t.set({total:o,uploaded:o-u.length-h}),$(m))).catch(s=>{if(console.error("Upload failed:",s),h-=1,u.push(f),d+=1,d<5)return $(m);throw new Error("Failed uploading after 5 attempts")}),$(m)])};return n.createVersion({modId:e}).then(async m=>(t.set({total:o,uploaded:0}),await $(m.data.createVersion),m.data.createVersion)).then(m=>(console.log("Finalizing",{versionID:m}),n.finalizeCreateVersion({modId:e,versionId:m,version:r}).then(()=>new Promise((f,g)=>{let b=0;const s=setInterval(()=>{if(b==60)return clearInterval(s),g(new Error("Timed out waiting for mod processing"));n.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),b++},1e4);n.checkVersionUploadState.variables.versionId=m;const p=n.checkVersionUploadState.subscribe(c=>{if(!c.fetching){if(c.error){clearInterval(s),g(new Error(c.error.message)),setTimeout(p);return}!c.data||!c.data.checkVersionUploadState||!c.data.checkVersionUploadState.version||!c.data.checkVersionUploadState.version.id||(p(),clearInterval(s),f(c.data.checkVersionUploadState))}})})))).catch(m=>{throw console.error(m),m})};function W(i){let e,r;return e=new ge({props:{description:"Creating a new version of mod "+i[1].data.mod.name,title:"New version of mod "+i[1].data.mod.name}}),{c(){z(e.$$.fragment)},l(t){M(e.$$.fragment,t)},m(t,n){q(e,t,n),r=!0},p(t,n){const a={};n&2&&(a.description="Creating a new version of mod "+t[1].data.mod.name),n&2&&(a.title="New version of mod "+t[1].data.mod.name),e.$set(a)},i(t){r||(E(e.$$.fragment,t),r=!0)},o(t){C(e.$$.fragment,t),r=!1},d(t){A(e,t)}}}function $e(i){let e=i[1].data.mod.name+"",r;return{c(){r=P(e)},l(t){r=I(t,e)},m(t,n){w(t,r,n)},p(t,n){n&2&&e!==(e=t[1].data.mod.name+"")&&Q(r,e)},d(t){t&&_(r)}}}function we(i){let e;return{c(){e=P("...")},l(r){e=I(r,"...")},m(r,t){w(r,e,t)},p:T,d(r){r&&_(e)}}}function Ve(i){let e,r,t,n;e=new de({props:{onSubmit:i[8],modReference:i[1].data.mod.mod_reference}});let a=i[3]&&Y(i);return{c(){z(e.$$.fragment),r=F(),a&&a.c(),t=U()},l(o){M(e.$$.fragment,o),r=D(o),a&&a.l(o),t=U()},m(o,u){q(e,o,u),w(o,r,u),a&&a.m(o,u),w(o,t,u),n=!0},p(o,u){const l={};u&2&&(l.modReference=o[1].data.mod.mod_reference),e.$set(l),o[3]?a?a.p(o,u):(a=Y(o),a.c(),a.m(t.parentNode,t)):a&&(a.d(1),a=null)},i(o){n||(E(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){A(e,o),o&&_(r),a&&a.d(o),o&&_(t)}}}function ye(i){let e,r,t=i[1].error.message+"",n;return{c(){e=y("p"),r=P("Oh no... "),n=P(t)},l(a){e=S(a,"P",{});var o=j(e);r=I(o,"Oh no... "),n=I(o,t),o.forEach(_)},m(a,o){w(a,e,o),v(e,r),v(e,n)},p(a,o){o&2&&t!==(t=a[1].error.message+"")&&Q(n,t)},i:T,o:T,d(a){a&&_(e)}}}function Se(i){let e,r;return{c(){e=y("p"),r=P("Loading...")},l(t){e=S(t,"P",{});var n=j(e);r=I(n,"Loading..."),n.forEach(_)},m(t,n){w(t,e,n),v(e,r)},p:T,i:T,o:T,d(t){t&&_(e)}}}function Y(i){let e,r,t,n,a,o,u,l,k=i[4].toFixed(0)+"",h,d,$,m,f;return{c(){e=y("div"),r=y("div"),t=y("div"),n=y("span"),a=P(i[3]),o=F(),u=y("div"),l=y("span"),h=P(k),d=P("%"),$=F(),m=y("div"),f=y("div"),this.h()},l(g){e=S(g,"DIV",{class:!0});var b=j(e);r=S(b,"DIV",{class:!0});var s=j(r);t=S(s,"DIV",{});var p=j(t);n=S(p,"SPAN",{class:!0});var c=j(n);a=I(c,i[3]),c.forEach(_),p.forEach(_),o=D(s),u=S(s,"DIV",{class:!0});var V=j(u);l=S(V,"SPAN",{class:!0});var R=j(l);h=I(R,k),d=I(R,"%"),R.forEach(_),V.forEach(_),s.forEach(_),$=D(b),m=S(b,"DIV",{class:!0});var G=j(m);f=S(G,"DIV",{style:!0,class:!0}),j(f).forEach(_),G.forEach(_),b.forEach(_),this.h()},h(){N(n,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),N(l,"class","text-xs font-semibold inline-block text-white"),N(u,"class","text-right"),N(r,"class","flex mb-2 items-center justify-between"),J(f,"width",i[4].toFixed(0)+"%"),N(f,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),N(m,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),N(e,"class","relative pt-4")},m(g,b){w(g,e,b),v(e,r),v(r,t),v(t,n),v(n,a),v(r,o),v(r,u),v(u,l),v(l,h),v(l,d),v(e,$),v(e,m),v(m,f)},p(g,b){b&8&&Q(a,g[3]),b&16&&k!==(k=g[4].toFixed(0)+"")&&Q(h,k),b&16&&J(f,"width",g[4].toFixed(0)+"%")},d(g){g&&_(e)}}}function je(i){let e,r,t,n;const a=[Se,ye,Ve],o=[];function u(l,k){return l[1].fetching?0:l[1].error?1:2}return e=u(i),r=o[e]=a[e](i),{c(){r.c(),t=U()},l(l){r.l(l),t=U()},m(l,k){o[e].m(l,k),w(l,t,k),n=!0},p(l,k){let h=e;e=u(l),e===h?o[e].p(l,k):(Z(),C(o[h],1,1,()=>{o[h]=null}),H(),r=o[e],r?r.p(l,k):(r=o[e]=a[e](l),r.c()),E(r,1),r.m(t.parentNode,t))},i(l){n||(E(r),n=!0)},o(l){C(r),n=!1},d(l){o[e].d(l),l&&_(t)}}}function Ee(i){let e,r;return e=new ie({props:{$$slots:{default:[je]},$$scope:{ctx:i}}}),{c(){z(e.$$.fragment)},l(t){M(e.$$.fragment,t)},m(t,n){q(e,t,n),r=!0},p(t,n){const a={};n&65562&&(a.$$scope={dirty:n,ctx:t}),e.$set(a)},i(t){r||(E(e.$$.fragment,t),r=!0)},o(t){C(e.$$.fragment,t),r=!1},d(t){A(e,t)}}}function Pe(i){let e,r;return{c(){e=y("span"),r=P(i[2])},l(t){e=S(t,"SPAN",{});var n=j(e);r=I(n,i[2]),n.forEach(_)},m(t,n){w(t,e,n),v(e,r)},p(t,n){n&4&&Q(r,t[2])},d(t){t&&_(e)}}}function Ie(i){let e,r,t,n,a,o,u,l,k,h,d=!i[1].fetching&&!i[1].error&&i[1].data.mod&&W(i);function $(s,p){if(s[1].fetching)return we;if(!s[1].error)return $e}let m=$(i),f=m&&m(i);o=new re({props:{$$slots:{default:[Ee]},$$scope:{ctx:i}}});function g(s){i[10](s)}let b={$$slots:{default:[Pe]},$$scope:{ctx:i}};return i[0]!==void 0&&(b.running=i[0]),l=new fe({props:b}),oe.push(()=>ne(l,"running",g)),{c(){d&&d.c(),e=U(),r=F(),t=y("h1"),n=P(`New Version for
  `),f&&f.c(),a=F(),z(o.$$.fragment),u=F(),z(l.$$.fragment),this.h()},l(s){const p=se('[data-svelte="svelte-qrqlce"]',document.head);d&&d.l(p),e=U(),p.forEach(_),r=D(s),t=S(s,"H1",{class:!0});var c=j(t);n=I(c,`New Version for
  `),f&&f.l(c),c.forEach(_),a=D(s),M(o.$$.fragment,s),u=D(s),M(l.$$.fragment,s),this.h()},h(){N(t,"class","text-4xl my-4 font-bold")},m(s,p){d&&d.m(document.head,null),v(document.head,e),w(s,r,p),w(s,t,p),v(t,n),f&&f.m(t,null),w(s,a,p),q(o,s,p),w(s,u,p),q(l,s,p),h=!0},p(s,[p]){!s[1].fetching&&!s[1].error&&s[1].data.mod?d?(d.p(s,p),p&2&&E(d,1)):(d=W(s),d.c(),E(d,1),d.m(e.parentNode,e)):d&&(Z(),C(d,1,1,()=>{d=null}),H()),m===(m=$(s))&&f?f.p(s,p):(f&&f.d(1),f=m&&m(s),f&&(f.c(),f.m(t,null)));const c={};p&65562&&(c.$$scope={dirty:p,ctx:s}),o.$set(c);const V={};p&65540&&(V.$$scope={dirty:p,ctx:s}),!k&&p&1&&(k=!0,V.running=s[0],ae(()=>k=!1)),l.$set(V)},i(s){h||(E(d),E(o.$$.fragment,s),E(l.$$.fragment,s),h=!0)},o(s){C(d),C(o.$$.fragment,s),C(l.$$.fragment,s),h=!1},d(s){d&&d.d(s),_(e),s&&_(r),s&&_(t),f&&f.d(),s&&_(a),A(o,s),s&&_(u),A(l,s)}}}const Ke=ce();function Ce(i,e,r){let t,n,a,{modId:o}=e;const u=B("");O(i,u,c=>r(3,n=c));const l=B(0);O(i,l,c=>r(4,a=c));const k=B();k.subscribe(c=>{c&&(c.uploaded===c.total?(u.set("Processing..."),l.set(100)):(u.set(`Uploading: ${c.uploaded}/${c.total}`),l.set(c.uploaded/c.total*100)))});let h="",d=!1;const $=K(me,{mod:o});O(i,$,c=>r(1,t=c)),X($);const m=L({query:_e}),f=L({query:he}),g=L({query:be}),b=K(pe,{versionId:void 0,modId:void 0},{pause:!0});X(b);const s=async c=>ve(c.file,le($).data.mod.id,{changelog:c.changelog,stability:c.stability},k,{createVersion:m,uploadVersionPart:f,finalizeCreateVersion:g,checkVersionUploadState:b}).then(V=>{console.log({success:V}),ue(ke+"/mod/"+o+"/version/"+V.version.id)}).catch(V=>{console.error(V),r(2,h="Error creating version: "+V.message),r(0,d=!0),u.set("")});function p(c){d=c,r(0,d)}return i.$$set=c=>{"modId"in c&&r(9,o=c.modId)},i.$$.update=()=>{i.$$.dirty&2&&t.data&&(b.variables.modId=t.data.mod.id),i.$$.dirty&1&&(d||r(2,h=""))},[d,t,h,n,a,u,l,$,s,o,p]}class Xe extends x{constructor(e){super();ee(this,e,Ce,Ie,te,{modId:9})}}export{Xe as default,Ke as load};
//# sourceMappingURL=new-version.svelte-ea466b09.js.map
